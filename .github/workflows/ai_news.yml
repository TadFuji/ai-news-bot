# AI ãƒ‹ãƒ¥ãƒ¼ã‚¹åé›†ãƒ»ç¿»è¨³ãƒœãƒƒãƒˆ - GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
#
# æ©Ÿèƒ½:
#   - æ¯æ—¥ JST 7:00 ã«è‡ªå‹•å®Ÿè¡Œ
#   - æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ï¼ˆActions ã‚¿ãƒ–ã‹ã‚‰ï¼‰
#   - GitHub Pages ã«ãƒ‡ãƒ—ãƒ­ã‚¤
#
# å¿…è¦ãªã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ:
#   - GOOGLE_API_KEY: Google Gemini API ã‚­ãƒ¼

name: AI News Collector

on:
  schedule:
    # æ¯æ—¥ JST 7:00 ã«å®Ÿè¡Œ (UTC 22:00 = å‰æ—¥22æ™‚)
    - cron: '0 22 * * *'
  
  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
  workflow_dispatch:

  # ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã§å®Ÿè¡Œï¼ˆä¿®æ­£ã®å³æ™‚åæ˜ ç”¨ï¼‰
  push:
    branches:
      - main

# GitHub Pages ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã®æ¨©é™
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  collect-news:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # 2. Python ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # 3. ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # 4. ãƒ‹ãƒ¥ãƒ¼ã‚¹åé›†ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
      - name: Run AI News Collector
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: python ai_news_collector.py
      
      # 5. GitHub Pages ç”¨ã«ãƒ“ãƒ«ãƒ‰
      - name: Build Pages
        run: python build_pages.py
      
      # 6. å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
      - name: Upload news output
        uses: actions/upload-artifact@v4
        with:
          name: ai-news-${{ github.run_number }}
          path: output/*.md
          retention-days: 30
      
      # 7. çµæœã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦ãƒªãƒã‚¸ãƒˆãƒªã«ä¿å­˜
      - name: Commit and push results
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add output/*.md docs/*.json || true
          git diff --staged --quiet || git commit -m "ğŸ“° AI News Update: $(date +'%Y-%m-%d %H:%M')"
          git push || true

  # GitHub Pages ã¸ãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-pages:
    needs: collect-news
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main  # æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆã‚’å–å¾—
      
      - name: Pull latest changes
        run: git pull origin main
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs
      
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

