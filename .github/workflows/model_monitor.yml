name: Monthly AI Model Pricing Monitor

on:
  schedule:
    # Run at 00:00 on the 1st of every month
    - cron: '0 0 1 * *'
  workflow_dispatch:

jobs:
  check-models:
    runs-on: ubuntu-latest
    permissions:
      contents: write # To save the updated existing_models.json

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          pip install requests google-genai python-dotenv

      - name: Run Model Monitor
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
        run: |
          python monitor_models.py

      - name: Check for Alerts
        id: check_alert
        run: |
          # If an alert file (model_alert_*) was created today, set output
          if ls model_alert_*.md 1> /dev/null 2>&1; then
            echo "has_alert=true" >> $GITHUB_OUTPUT
            echo "ALERT FOUND"
          else
            echo "has_alert=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit & Push Changes (History Update)
        if: steps.check_alert.outputs.has_alert == 'true'
        run: |
          git config --global user.name 'AI Model Monitor'
          git config --global user.email 'bot@example.com'
          git add existing_models.json
          git commit -m "Update known AI models list [Skip CI]" || echo "No changes to commit"
          git push

      - name: Notify (Optional)
        if: steps.check_alert.outputs.has_alert == 'true'
        run: |
          echo "New models detected! Check the repository for the alert Markdown file."
          # Here you could add a LINE Notify or Slack step if desired.
